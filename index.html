// Worker code for handling form submissions securely
// This worker will receive POST requests, parse the form data,
// and send an email using Mailchannels (Cloudflare's recommended email service).

// Define the recipient email address for inquiries
const RECIPIENT_EMAIL = "Connect@Imperial-Contracting-Group.com";
const SENDER_EMAIL = "no-reply@imperial-contracting-group.com"; // Use a "no-reply" email on your domain

addEventListener("fetch", event => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  // Only allow POST requests to this endpoint
  if (request.method !== "POST") {
    return new Response(JSON.stringify({ error: "Method Not Allowed" }), {
      status: 405,
      headers: { "Content-Type": "application/json" }
    });
  }

  // Ensure the request is coming from your domain (optional but recommended for security)
  // You would replace 'imperial-contracting-group.com' with your actual domain
  const origin = request.headers.get('Origin');
  if (origin && !origin.includes('imperial-contracting-group.com') && !origin.includes('pages.dev')) {
      return new Response(JSON.stringify({ error: "Forbidden - Invalid Origin" }), {
          status: 403,
          headers: { "Content-Type": "application/json" }
      });
  }

  try {
    // Parse the JSON body from the form submission
    const formData = await request.json();

    // Extract form fields
    const { name, email, projectType, message } = formData;

    // Basic validation
    if (!name || !email || !message) {
      return new Response(JSON.stringify({ error: "Missing required fields (Name, Email, Message)" }), {
        status: 400,
        headers: { "Content-Type": "application-type: application/json" }
      });
    }

    // Construct the email content
    const emailSubject = `New Inquiry from ${name} via Website`;
    const emailBody = `
      Name: ${name}
      Email: ${email}
      Project Type: ${projectType || 'Not specified'}
      Message:
      ${message}
    `;

    // Mailchannels API endpoint for sending emails
    const mailchannelsUrl = "https://api.mailchannels.net/tx/v1/send";

    // Prepare the email payload for Mailchannels API
    const mailchannelsPayload = {
      personalizations: [{ to: [{ email: RECIPIENT_EMAIL }] }],
      from: { email: SENDER_EMAIL, name: "Imperial Contracting Inquiry" },
      subject: emailSubject,
      content: [{ type: "text/plain", value: emailBody }]
    };

    // Send the email using Mailchannels API
    const mailchannelsResponse = await fetch(mailchannelsUrl, {
      method: "POST",
      headers: {
        "content-type": "application/json",
      },
      body: JSON.stringify(mailchannelsPayload),
    });

    // Check Mailchannels response
    if (mailchannelsResponse.ok) {
      return new Response(JSON.stringify({ message: "Form submitted successfully!" }), {
        status: 200,
        headers: { "Content-Type": "application/json" }
      });
    } else {
      const errorText = await mailchannelsResponse.text();
      console.error("Mailchannels API Error:", errorText);
      return new Response(JSON.stringify({ error: `Failed to send email: ${mailchannelsResponse.statusText}. Details: ${errorText}` }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }

  } catch (error) {
    console.error("Worker error:", error);
    return new Response(JSON.stringify({ error: "Internal server error" }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
